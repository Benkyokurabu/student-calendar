<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>先生用スケジュール表</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 24px;
      background: #f5f7fb;
      color: #111827;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    h1 { margin: 0 0 8px 0; font-size: 18px; }
    h2 { margin: 0 0 12px 0; font-size: 15px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    select, button { font-size: 14px; }
    select {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #fff;
      min-width: 180px;
    }
    button {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #fff;
      cursor: pointer;
    }
    button:hover { background: #f3f4f6; }
    .muted { color: #6b7280; font-size: 13px; }
    #filterSummary { font-weight: 700; color: #111827; }
    .pill {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      font-size: 12px;
      margin-left: 8px;
    }
    .error {
      background: #fff1f2;
      border: 1px solid #fecdd3;
      color: #9f1239;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
    }

    .teacher-checks {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      margin-top: 10px;
    }
    .chk {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #fff;
      user-select: none;
    }
    .chk input { transform: translateY(1px); }

    .cal-wrap { display: grid; gap: 10px; }
    .cal-head { display:flex; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-bottom:10px; }
    .cal-head-note { margin-left:auto; text-align:right; max-width:520px; line-height:1.35; }

    .dow {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      font-size: 12px;
      color: #6b7280;
      padding: 0 2px;
    }
    .dow div { text-align: center; }
    .dow div.sun { color: #b91c1c; font-weight: 700; }
    .dow div.sat { color: #1d4ed8; font-weight: 700; }

    .cell.sun:not(.off) { background: #fff7f7; }
    .cell.sat:not(.off) { background: #f3f8ff; }
    .cell.sun:hover:not(.off), .cell.sat:hover:not(.off) { filter: brightness(0.99); }

    .cell.today:not(.off) { border-color: #93c5fd; }
    .cell.today .date-num {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: #2563eb;
      color: #ffffff;
      font-weight: 800;
      line-height: 1;
    }

    .cell.has-lessons:not(.off)::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      border-radius: 12px 0 0 12px;
      background: rgba(37, 99, 235, 0.35);
    }

    .lesson-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .lesson-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 3px 6px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      line-height: 1.2;
      overflow: hidden;
    }
    .lesson-time {
      font-size: 12px;
      font-weight: 800;
      color: #111827;
      white-space: nowrap;
    }
    .title-tag {
      font-size: 12px;
      font-weight: 700;
      color: #374151;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .campus-tag {
      margin-left: auto;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #e5e7eb;
      font-size: 12px;
      font-weight: 700;
      white-space: nowrap;
    }
    .grade-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 800;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    .grade-e4 { border-color: #a7f3d0; background: #ecfdf5; }
    .grade-e4.grade-pill { background: #d1fae5; border-color: #6ee7b7; color: #065f46; }

    .grade-e5 { border-color: #bfdbfe; background: #eff6ff; }
    .grade-e5.grade-pill { background: #dbeafe; border-color: #93c5fd; color: #1d4ed8; }

    .grade-e6 { border-color: #fde68a; background: #fffbeb; }
    .grade-e6.grade-pill { background: #fef3c7; border-color: #fcd34d; color: #92400e; }

    .grade-j1 { border-color: #e9d5ff; background: #faf5ff; }
    .grade-j1.grade-pill { background: #f3e8ff; border-color: #d8b4fe; color: #6b21a8; }

    .grade-j2 { border-color: #fecdd3; background: #fff1f2; }
    .grade-j2.grade-pill { background: #ffe4e6; border-color: #fda4af; color: #9f1239; }

    .grade-j3 { border-color: #c7d2fe; background: #eef2ff; }
    .grade-j3.grade-pill { background: #e0e7ff; border-color: #a5b4fc; color: #3730a3; }

    .more-indicator {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      margin-top:6px;
      padding:2px 8px;
      border-radius:999px;
      background:#f3f4f6;
      border:1px solid #e5e7eb;
      color:#374151;
      font-size:11px;
      font-weight:700;
      width:fit-content;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .cell {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      min-height: 84px;
      padding: 8px;
      position: relative;
      cursor: pointer;
      transition: background 0.12s ease, border-color 0.12s ease, transform 0.06s ease;
    }
    .cell:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }
    .cell:active { transform: translateY(1px); }
    .cell.off {
      background: #f8fafc;
      border-color: #eef2f7;
      color: #94a3b8;
      cursor: default;
    }
    .cell.selected {
      border-color: #2563eb;
      background: #eff6ff;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.16) inset;
    }
    .date-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 6px;
    }
    .date-num { font-weight: 800; font-size: 13px; }
    .badge {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      white-space: nowrap;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
    }
    th {
      text-align: left;
      color: #374151;
      font-weight: 700;
      background: #f9fafb;
    }
    tbody tr:nth-child(even) td { background: #fcfdff; }
    td.col-time { font-weight: 900; color: #111827; font-size: 14px; letter-spacing: .2px; }
    .nowrap { white-space: nowrap; }
    .right { text-align: right; }
    #dayDetailArea.flash .card {
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.16);
    }

    @media (max-width: 900px) {
      body { margin: 14px; }
      .grid, .dow { gap: 6px; }
      .cell { min-height: 76px; padding: 6px; }
      select { min-width: 150px; }
      .title-tag { font-size: 11px; }
      .lesson-time, .campus-tag { font-size: 11px; }
    }
  </style>
</head>
<body>

  <div class="card">
    <h1>先生用スケジュール表 <span id="ym-pill" class="pill"></span></h1>
    <div id="filterSummary" class="muted" style="margin-top:6px;"></div>
    <div class="row" style="margin-top:10px;">
      <button id="prevBtn">◀ 前月</button>
      <button id="todayBtn">今月</button>
      <button id="nextBtn">翌月 ▶</button>

      <span style="width:12px;"></span>

      <label class="muted">校舎</label>
      <select id="campusSelect">
        <option value="all">すべて</option>
        <option value="hon">本校のみ</option>
        <option value="minami">南教室のみ</option>
      </select>

      <button id="clearBtn">選択リセット</button>
    </div>

    <div style="margin-top:14px;">
      <div class="muted" style="margin-bottom:6px;">先生（複数選択可）</div>
      <div id="teacherChecks" class="teacher-checks"></div>
    </div>

    <div class="muted" style="margin-top:10px;">
      ※ 初回表示は <code>teacher_schedule_latest.json</code> を読み込みます。<br/>
      ※ 前月・翌月へ移動した場合は <code>teacher_schedule_YYYY-MM.json</code> を読み込みます。
    </div>
  </div>

  <div id="statusArea"></div>

  <div class="card">
    <div class="cal-head">
      <h2 style="margin:0;">月間カレンダー</h2>
      <div class="cal-head-note muted">※ 日付をクリックすると、その日の授業（詳細）が下に表示されます。</div>
    </div>
    <div class="cal-wrap">
      <div class="dow">
        <div class="sun">日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div class="sat">土</div>
      </div>
      <div id="monthGrid" class="grid"></div>
    </div>
  </div>

  <div id="dayDetailArea"></div>

<script>
(() => {
  const STORAGE_KEY = "benkyo_teacher_calendar_v4";

  const teacherChecks = document.getElementById("teacherChecks");
  const campusSelect = document.getElementById("campusSelect");
  const ymPill = document.getElementById("ym-pill");
  const filterSummary = document.getElementById("filterSummary");
  const statusArea = document.getElementById("statusArea");
  const monthGrid = document.getElementById("monthGrid");
  const dayDetailArea = document.getElementById("dayDetailArea");

  document.getElementById("prevBtn").addEventListener("click", () => shiftMonth(-1));
  document.getElementById("nextBtn").addEventListener("click", () => shiftMonth(1));
  document.getElementById("todayBtn").addEventListener("click", () => setToThisMonth());
  document.getElementById("clearBtn").addEventListener("click", () => clearSelections());

  const today = new Date();
  const TODAY_YMD = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}`;
  let currentYM = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}`;

  let cachedLatestPayload = null;
  let cachedLatestYM = null;
  let payload = { year: null, month: null, teachers: [], items: [] };

  const TEACHER_SORT_ORDER = {
    "岩本": 1,
    "工藤": 2,
    "金子": 3,
    "金城": 4,
    "鈴木": 5,
    "髙山": 6,
    "高山": 6,
    "治彦": 7,
    "真下": 8,
    "森松": 9,
    "未判定": 999
  };

  let state = {
    teachers: [],
    campus: "all",
    selectedDate: null,
  };

  campusSelect.addEventListener("change", () => {
    state.campus = campusSelect.value;
    state.selectedDate = null;
    saveState();
    renderAll();
  });

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);

      if (Array.isArray(obj.teachers)) {
        state.teachers = obj.teachers.map(x => String(x || "").trim()).filter(Boolean);
      } else if (typeof obj.teacher === "string" && obj.teacher.trim()) {
        state.teachers = [obj.teacher.trim()];
      }

      if (typeof obj.selectedDate === "string" || obj.selectedDate === null) state.selectedDate = obj.selectedDate;
      if (["all", "hon", "minami"].includes(obj.campus)) state.campus = obj.campus;
    } catch (_) {}
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function clearSelections() {
    state.teachers = [];
    state.campus = "all";
    state.selectedDate = null;
    campusSelect.value = state.campus;
    rebuildTeacherChecks();
    saveState();
    renderAll();
  }

  function pad2(n) {
    return String(n).padStart(2, "0");
  }

  function ymToLabel(ym) {
    const [y, m] = ym.split("-");
    return `${y}年${Number(m)}月`;
  }

  function ymdToLabel(ymd) {
    if (!ymd) return "";
    const dt = new Date(ymd + "T00:00:00");
    const w = "日月火水木金土"[dt.getDay()];
    return `${ymd}（${w}）`;
  }

  function campusLabel(code) {
    if (code === "hon") return "本校";
    if (code === "minami") return "南教室";
    return code || "";
  }

  function campusShort(code) {
    if (code === "hon") return "本";
    if (code === "minami") return "南";
    return (code || "").toString();
  }

  function escapeHtml(text) {
    return String(text ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function timeStart(timeStr) {
    return (timeStr || "").split(/[～~]/)[0].trim();
  }

  function timeStartMinutes(timeStr) {
    const t = timeStart(timeStr);
    const m = t.match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return 9999;
    return Number(m[1]) * 60 + Number(m[2]);
  }

  function normalizeTeacherName(name) {
    let s = String(name || "").trim();
    if (!s || s === "未判定") return s;
    if (s === "高山") s = "髙山";
    return s.endsWith("先生") ? s : `${s}先生`;
  }

  function getTeacherLabel(itemOrName) {
    if (itemOrName && typeof itemOrName === "object") {
      const explicit = String(itemOrName.teacherLabel || "").trim();
      if (explicit) return explicit;
      return normalizeTeacherName(itemOrName.teacher || "");
    }
    return normalizeTeacherName(itemOrName);
  }

  function teacherSortKey(name) {
    const s = String(name || "").trim();
    const base = (s === "高山") ? "髙山" : s;
    if (Object.prototype.hasOwnProperty.call(TEACHER_SORT_ORDER, base)) {
      return [0, TEACHER_SORT_ORDER[base], base];
    }
    return [1, 9999, base];
  }

  function sortTeachers(list) {
    return [...list].sort((a, b) => {
      const ka = teacherSortKey(a);
      const kb = teacherSortKey(b);
      return (ka[0] - kb[0]) || (ka[1] - kb[1]) || String(ka[2]).localeCompare(String(kb[2]), "ja");
    });
  }

  function gradeLabel(code) {
    return {
      e4: "小4",
      e5: "小5",
      e6: "小6",
      j1: "中1",
      j2: "中2",
      j3: "中3",
    }[code] || "";
  }

  function gradeClass(code) {
    return gradeLabel(code) ? `grade-${code}` : "";
  }

  function normalizePayload(raw) {
    if (Array.isArray(raw)) {
      const items = raw.map(normalizeItem).filter(Boolean);
      const inferredYM = inferYMFromItems(items);
      return {
        year: inferredYM ? Number(inferredYM.slice(0, 4)) : null,
        month: inferredYM ? Number(inferredYM.slice(5, 7)) : null,
        teachers: collectTeachers(items),
        items,
      };
    }

    const items = Array.isArray(raw?.items) ? raw.items.map(normalizeItem).filter(Boolean) : [];
    const inferredYM = inferYMFromItems(items);
    const year = Number(raw?.year || (inferredYM ? inferredYM.slice(0, 4) : 0)) || null;
    const month = Number(raw?.month || (inferredYM ? inferredYM.slice(5, 7) : 0)) || null;

    let teachers = Array.isArray(raw?.teachers) ? raw.teachers.map(x => String(x || "").trim()).filter(Boolean) : [];
    if (teachers.length === 0) teachers = collectTeachers(items);

    return { year, month, teachers, items };
  }

  function normalizeItem(x) {
    if (!x || typeof x !== "object") return null;
    const item = {
      date: String(x.date || ""),
      time: String(x.time || ""),
      campus: String(x.campus || ""),
      campusLabel: String(x.campusLabel || ""),
      room: String(x.room || "").trim(),
      teacher: String(x.teacher || "").trim(),
      teacherLabel: String(x.teacherLabel || "").trim(),
      title: String(x.title || x.displayTitle || x.label || "").trim(),
      rawText: String(x.rawText || ""),
      faceToFace: !!x.faceToFace,
      subject: String(x.subject || "").trim(),
      grade: String(x.grade || "").trim(),
      class: String(x.class || "").trim(),
      label: String(x.label || "").trim(),
      displayTitle: String(x.displayTitle || "").trim(),
    };
    if (!/^\d{4}-\d{2}-\d{2}$/.test(item.date)) return null;
    return item;
  }

  function collectTeachers(items) {
    const uniq = Array.from(new Set(items.map(x => x.teacher).filter(Boolean)));
    return sortTeachers(uniq);
  }

  function inferYMFromItems(items) {
    const dates = items
      .map(x => String(x.date || ""))
      .filter(s => /^\d{4}-\d{2}-\d{2}$/.test(s))
      .sort();
    if (dates.length === 0) return null;
    return dates[0].slice(0, 7);
  }

  async function fetchJsonFromCandidates(candidates, labelForError) {
    const tried = [];
    for (const base of candidates) {
      const url = `${base}?ts=${Date.now()}`;
      tried.push(url);
      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) continue;
        return await res.json();
      } catch (_) {}
    }
    throw new Error(`${labelForError} が見つかりません。試行URL: ` + tried.join(" , "));
  }

  async function fetchLatestJson() {
    const candidates = [
      "teacher_schedule_latest.json",
      "./teacher_schedule_latest.json",
      "../teacher_schedule_latest.json",
      "./data/teacher_schedule_latest.json",
      "./json/teacher_schedule_latest.json",
    ];
    return await fetchJsonFromCandidates(candidates, "teacher_schedule_latest.json");
  }

  async function fetchJsonForMonth(ym) {
    if (cachedLatestPayload && cachedLatestYM === ym) return cachedLatestPayload;
    const candidates = [
      `teacher_schedule_${ym}.json`,
      `./teacher_schedule_${ym}.json`,
      `../teacher_schedule_${ym}.json`,
      `./data/teacher_schedule_${ym}.json`,
      `./json/teacher_schedule_${ym}.json`,
    ];
    return await fetchJsonFromCandidates(candidates, `teacher_schedule_${ym}.json`);
  }

  async function loadInitialMonth() {
    ymPill.textContent = ymToLabel(currentYM);
    statusArea.innerHTML = "";
    monthGrid.innerHTML = "";
    dayDetailArea.innerHTML = "";

    try {
      const raw = await fetchLatestJson();
      payload = normalizePayload(raw);
      cachedLatestPayload = raw;
      cachedLatestYM = payload.year && payload.month ? `${payload.year}-${pad2(payload.month)}` : inferYMFromItems(payload.items);
      if (cachedLatestYM) currentYM = cachedLatestYM;
      rebuildTeacherChecks();
      renderAll();
    } catch (_) {
      await loadMonth(currentYM);
    }
  }

  async function loadMonth(ym) {
    ymPill.textContent = ymToLabel(ym);
    statusArea.innerHTML = "";
    monthGrid.innerHTML = "";
    dayDetailArea.innerHTML = "";

    try {
      const raw = await fetchJsonForMonth(ym);
      payload = normalizePayload(raw);
      rebuildTeacherChecks();
      renderAll();
    } catch (e) {
      payload = { year: Number(ym.slice(0,4)), month: Number(ym.slice(5,7)), teachers: [], items: [] };
      rebuildTeacherChecks();
      renderAll();
      statusArea.innerHTML = `
        <div class="card error">
          <div><b>${escapeHtml(ymToLabel(ym))}のデータが読み込めませんでした。</b></div>
          <div style="margin-top:6px;">原因例：この月の <code>teacher_schedule_${escapeHtml(ym)}.json</code> をまだアップしていない／ファイル名が違う</div>
          <div style="margin-top:6px;">詳細：${escapeHtml(String(e.message || e))}</div>
        </div>
      `;
    }
  }

  function shiftMonth(delta) {
    const [y, m] = currentYM.split("-").map(Number);
    const d = new Date(y, m - 1 + delta, 1);
    currentYM = `${d.getFullYear()}-${pad2(d.getMonth() + 1)}`;
    state.selectedDate = null;
    saveState();
    loadMonth(currentYM);
  }

  function setToThisMonth() {
    if (cachedLatestYM) {
      currentYM = cachedLatestYM;
      state.selectedDate = null;
      saveState();
      payload = normalizePayload(cachedLatestPayload || payload);
      rebuildTeacherChecks();
      renderAll();
      return;
    }
    const d = new Date();
    currentYM = `${d.getFullYear()}-${pad2(d.getMonth() + 1)}`;
    state.selectedDate = null;
    saveState();
    loadMonth(currentYM);
  }

  function rebuildTeacherChecks() {
    const teachers = Array.isArray(payload.teachers) && payload.teachers.length ? sortTeachers(payload.teachers) : collectTeachers(payload.items || []);
    const validSet = new Set(teachers);
    state.teachers = sortTeachers(state.teachers.filter(t => validSet.has(t)));

    if (teachers.length > 0 && state.teachers.length === 0) {
      state.teachers = [teachers[0]];
    }

    teacherChecks.innerHTML = "";

    if (teachers.length === 0) {
      teacherChecks.innerHTML = '<div class="muted">（先生データなし）</div>';
      saveState();
      campusSelect.value = state.campus;
      return;
    }

    for (const name of teachers) {
      const safe = String(name).replace(/[^a-zA-Z0-9_\-]/g, "_");
      const id = `teacher_${safe}`;
      const wrap = document.createElement("label");
      wrap.className = "chk";
      wrap.innerHTML = `
        <input type="checkbox" id="${id}">
        <span>${escapeHtml(getTeacherLabel(name))}</span>
      `;
      const input = wrap.querySelector("input");
      input.checked = state.teachers.includes(name);
      input.addEventListener("change", () => {
        if (input.checked) {
          if (!state.teachers.includes(name)) state.teachers.push(name);
        } else {
          state.teachers = state.teachers.filter(x => x !== name);
        }
        state.teachers = sortTeachers(state.teachers);
        state.selectedDate = null;
        saveState();
        renderAll();
      });
      teacherChecks.appendChild(wrap);
    }

    campusSelect.value = state.campus;
    saveState();
  }

  function getFilteredItems() {
    const selectedTeachers = new Set(state.teachers);
    const campus = state.campus;
    if (selectedTeachers.size === 0) return [];

    return (payload.items || [])
      .filter(item => {
        if (!selectedTeachers.has(item.teacher)) return false;
        if (campus !== "all" && item.campus !== campus) return false;
        return true;
      })
      .sort((a, b) => {
        const t = timeStartMinutes(a.time) - timeStartMinutes(b.time);
        if (t !== 0) return t;
        if ((a.campus || "") !== (b.campus || "")) return (a.campus || "").localeCompare(b.campus || "", "ja");
        if ((a.room || "") !== (b.room || "")) return (a.room || "").localeCompare(b.room || "", "ja");
        const ka = teacherSortKey(a.teacher);
        const kb = teacherSortKey(b.teacher);
        return (ka[0] - kb[0]) || (ka[1] - kb[1]) || String(ka[2]).localeCompare(String(kb[2]), "ja");
      });
  }

  function selectedSummaryText() {
    const names = sortTeachers(state.teachers).map(getTeacherLabel);
    const teacherText = names.length ? names.join("・") : "未選択";
    const campusText = state.campus === "all" ? "校舎：すべて" : `校舎：${campusLabel(state.campus)}`;
    return `${teacherText} ／ ${campusText}`;
  }

  function getItemsByDate(items) {
    const map = new Map();
    items.forEach(item => {
      if (!map.has(item.date)) map.set(item.date, []);
      map.get(item.date).push(item);
    });
    return map;
  }

  function buildMonthMatrix(ym) {
    const [y, m] = ym.split("-").map(Number);
    const first = new Date(y, m - 1, 1);
    const startDow = first.getDay();
    const daysInMonth = new Date(y, m, 0).getDate();

    const cells = [];
    for (let i = 0; i < 42; i++) {
      const dayNum = i - startDow + 1;
      if (dayNum < 1 || dayNum > daysInMonth) cells.push(null);
      else cells.push({ date: `${y}-${pad2(m)}-${pad2(dayNum)}`, dayNum });
    }
    return cells;
  }

  function getDisplayTitle(item) {
    return (item.displayTitle || item.title || item.label || item.rawText || "").trim();
  }

  function cellLessonHtml(item) {
    const t = timeStart(item.time);
    const title = getDisplayTitle(item);
    const campusRoom = `${campusShort(item.campus)}${item.room || ""}`;
    const gradeCode = item.grade || "";
    const gLabel = gradeLabel(gradeCode);
    const gClass = gradeClass(gradeCode);
    return `
      <div class="lesson-item ${escapeHtml(gClass)}">
        <span class="lesson-time">${escapeHtml(t)}</span>
        ${gLabel ? `<span class="grade-pill ${escapeHtml(gClass)}">${escapeHtml(gLabel)}</span>` : ``}
        <span class="title-tag">${escapeHtml(title)}</span>
        <span class="campus-tag">${escapeHtml(campusRoom)}</span>
      </div>
    `.trim();
  }

  function ensureSelectedDate(filtered) {
    const grouped = getItemsByDate(filtered);
    if (state.selectedDate && grouped.has(state.selectedDate)) return;
    if (TODAY_YMD.startsWith(currentYM) && grouped.has(TODAY_YMD)) {
      state.selectedDate = TODAY_YMD;
      saveState();
      return;
    }
    state.selectedDate = [...grouped.keys()].sort()[0] || null;
    saveState();
  }

  function renderMonthGrid(filtered) {
    monthGrid.innerHTML = "";
    const countByDate = getItemsByDate(filtered);
    const cells = buildMonthMatrix(currentYM);

    for (const cell of cells) {
      const div = document.createElement("div");
      div.className = "cell";

      if (!cell) {
        div.classList.add("off");
        div.innerHTML = `<div class="date-row"><span class="date-num"> </span></div>`;
        monthGrid.appendChild(div);
        continue;
      }

      const list = countByDate.get(cell.date) || [];
      const dt = new Date(cell.date + "T00:00:00");
      const dow = dt.getDay();
      if (dow === 0) div.classList.add("sun");
      if (dow === 6) div.classList.add("sat");
      if (cell.date === TODAY_YMD) div.classList.add("today");
      if (cell.date === state.selectedDate) div.classList.add("selected");
      if (list.length > 0) div.classList.add("has-lessons");

      const badge = list.length > 0 ? `<span class="badge">${list.length}件</span>` : "";
      const shown = list.slice(0, 3);
      const rest = Math.max(0, list.length - shown.length);
      const lessonsHtml = list.length > 0
        ? `<div class="lesson-list">${shown.map(cellLessonHtml).join("")}</div>` + (rest > 0 ? `<div class="more-indicator">＋${rest}件</div>` : ``)
        : `<div class="lesson-list"></div>`;

      div.innerHTML = `
        <div class="date-row">
          <span class="date-num">${cell.dayNum}</span>
          ${badge}
        </div>
        ${lessonsHtml}
      `;

      div.addEventListener("click", () => {
        state.selectedDate = cell.date;
        saveState();
        renderAll();
        setTimeout(() => {
          const card = document.getElementById("dayDetailCard");
          if (card) card.scrollIntoView({ behavior: "smooth", block: "start" });
          dayDetailArea.classList.add("flash");
          setTimeout(() => dayDetailArea.classList.remove("flash"), 700);
        }, 0);
      });

      monthGrid.appendChild(div);
    }
  }

  function renderDayDetail(filtered) {
    dayDetailArea.innerHTML = "";

    if (state.teachers.length === 0) {
      dayDetailArea.innerHTML = `
        <div class="card"><div class="muted">先生にチェックを入れると、その月の授業が表示されます。</div></div>
      `;
      return;
    }

    ensureSelectedDate(filtered);

    if (!state.selectedDate) {
      dayDetailArea.innerHTML = `
        <div class="card"><div class="muted">この月には授業データがありません。</div></div>
      `;
      return;
    }

    const date = state.selectedDate;
    const items = filtered.filter(x => x.date === date).sort((a, b) => {
      const t = timeStartMinutes(a.time) - timeStartMinutes(b.time);
      if (t !== 0) return t;
      if ((a.campus || "") !== (b.campus || "")) return (a.campus || "").localeCompare(b.campus || "", "ja");
      if ((a.room || "") !== (b.room || "")) return (a.room || "").localeCompare(b.room || "", "ja");
      const ka = teacherSortKey(a.teacher);
      const kb = teacherSortKey(b.teacher);
      return (ka[0] - kb[0]) || (ka[1] - kb[1]) || String(ka[2]).localeCompare(String(kb[2]), "ja");
    });

    dayDetailArea.innerHTML = `
      <div class="card" id="dayDetailCard">
        <h2>日別詳細：${escapeHtml(ymdToLabel(date))}</h2>
        ${items.length === 0
          ? `<div class="muted">この日は、選択中の条件に一致する予定がありません。</div>`
          : `
            <table>
              <thead>
                <tr>
                  <th class="nowrap">時間</th>
                  <th>授業</th>
                  <th class="nowrap">先生</th>
                  <th class="nowrap">校舎</th>
                  <th class="nowrap right">教室</th>
                </tr>
              </thead>
              <tbody>
                ${items.map(it => `
                  <tr>
                    <td class="nowrap col-time">${escapeHtml(it.time)}</td>
                    <td>${gradeLabel(it.grade) ? `<span class="grade-pill ${escapeHtml(gradeClass(it.grade))}">${escapeHtml(gradeLabel(it.grade))}</span> ` : ``}${escapeHtml(getDisplayTitle(it))}</td>
                    <td class="nowrap">${escapeHtml(getTeacherLabel(it))}</td>
                    <td class="nowrap">${escapeHtml(it.campusLabel || campusLabel(it.campus))}</td>
                    <td class="nowrap right">${escapeHtml(it.room || "")}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          `}
      </div>
    `;
  }

  function renderAll() {
    ymPill.textContent = ymToLabel(currentYM);
    filterSummary.textContent = selectedSummaryText();

    const filtered = getFilteredItems();
    renderMonthGrid(filtered);
    renderDayDetail(filtered);

    statusArea.innerHTML = "";
    if (state.teachers.length > 0) {
      const days = new Set(filtered.map(x => x.date)).size;
      statusArea.innerHTML = `
        <div class="card">
          <div class="muted">
            表示対象：${escapeHtml(sortTeachers(state.teachers).map(getTeacherLabel).join("・"))} ／ 校舎：${state.campus === "all" ? "すべて" : escapeHtml(campusLabel(state.campus))}
            ／ 授業日数：${days}日 ／ 授業件数：${filtered.length}件
          </div>
        </div>
      `;
    }
  }

  loadState();
  campusSelect.value = state.campus;
  teacherChecks.innerHTML = '<div class="muted">読み込み中…</div>';
  loadInitialMonth();
})();
</script>
</body>
</html>
